---
title: "00-import"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "00-import" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "a0e8b3cd-3c98-4629-928f-f573d12fd0f4")
```

The purpose of this document is ...

```{r packages}
library("conflicted")
library(here)
library(tidyverse)
library(data.table)
library(TreeSummarizedExperiment)
library(mia)
library(miaViz)
library(scater)
library(patchwork)
library(tidyverse)
library(viridis)
library(hrbrthemes)
library(circlize)
library(networkD3)

prj_path <- normalizePath("..")
dpath <- here(prj_path, "pipeline/output")

source(here(prj_path, "R/utils.R"))
```

```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = F)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```

## Tasks

```{r}
fp_metadata <- here(prj_path, "data/metadata.xlsx")
fp_vir_taxa <- here(dpath, "taxonomy/taxonomy.tsv")
fp_vir_counts <- here(dpath, "abundance/abundance_contigs_count.tsv.gz")
fp_vir_trmean <- here(dpath, "abundance/abundance_contigs_trimmed_mean.tsv.gz")
fp_vir_tpm <- here(dpath, "abundance/abundance_contigs_tpm.tsv.gz")
fp_vir_covfrac <- here(dpath, "abundance/abundance_contigs_covered_fraction.tsv.gz")
fp_checkv <- here(dpath, "checkv/quality_summary.tsv")
fp_virsorter2 <- here(dpath, "virsorter2/out_vs2/final-viral-score.tsv")
fp_vcontact2 <- here(dpath, "taxonomy/out_vContact2/genome_by_genome_overview.csv")
fp_lifestyle <- here(dpath, "replicyc/scaffolds.fna.bacphlip")
fp_virhost <- here(dpath, "viralhost/out_iphop/Host_prediction_to_genome_m90.csv")
fp_dram_stats <- here(dpath, "dramv/dramv-distill/vMAG_stats.tsv")
fp_dram_anno <- here(dpath, "dramv/dramv-annotate/annotations.tsv")

smeta <- openxlsx::read.xlsx(fp_metadata) %>% 
  mutate(sample_id = as.factor(sample_id))
df_checkv <- read_CheckV(fp_checkv)
df_virsorter2 <- read_VirSorter2(fp_virsorter2)
vc2 <- read_vConTACT2(fp_vcontact2)
df_vcontact2 <- vc2$vc_tbl
anno_vcontact2_cluster <- vc2$vc_annotated
df_vtaxa <- read_vtaxonomy(fp_vir_taxa)  # will be replaced or removed
df_vrcyc <- read_lifestyle(fp_lifestyle)
# anno_virhost <- fread(fp_virhost)

df_dramstats <- fread(fp_dram_stats) %>% 
  column_to_rownames("V1") %>% 
  setnames(colnames(.), make.names(colnames(.))) %>% 
  dplyr::select(-c(VIRSorter.category)) %>% 
  setnames(colnames(.), paste0("dramv_", colnames(.))) %>% 
  rownames_to_column("virsorter2_contig_id")
```

```{r}
col_taxa <- c("vtaxa_Phylum", "vtaxa_Order", "vtaxa_Class", "vtaxa_Family", "vtaxa_Genus", "vtaxa_Species")
anno_all <- df_checkv %>% 
  left_join(df_vcontact2, by = "Contig") %>% 
  left_join(df_virsorter2, by = "Contig") %>% 
  left_join(df_lifestyle, by = "virsorter2_contig_id") %>%
  left_join(df_vtaxa, by = "virsorter2_contig_id") %>%
  left_join(df_dramstats, by = "virsorter2_contig_id") %>%
  mutate(checkv_contig_length = as.integer(checkv_contig_length)) %>% 
  mutate(virsorter2_category = as.integer(virsorter2_category)) %>% 
  arrange(desc(checkv_contig_length)) %>% 
  setnames(col_taxa, str_replace(col_taxa, "vtaxa_", ""))


anno_viral <- anno_all %>% 
  dplyr::filter(!is.na(virsorter2_contig_id))
  # dplyr::filter(!checkv_quality %in% c('Not-determined'))
```

```{r}
read_abundance2 <- function(fp, anno_vir) {
  df <- read_abundance(fp, anno_viral) %>% 
    column_to_rownames("Contig")
  return(df)
}

# df_counts <- read_abundance(fp_vir_counts, anno_viral)
df_counts <- read_abundance(fp_vir_counts, anno_viral, smeta$sample_id)
df_trmean <- read_abundance(fp_vir_trmean, anno_viral, smeta$sample_id)
df_covfrac <- read_abundance(fp_vir_covfrac, anno_viral, smeta$sample_id)
df_abundance <- create_viral_abundance(df_trmean, df_covfrac, covfrac_threshold=0.2) %>% 
  t()
df_abundance_rel <- df_abundance / rowSums(df_abundance)
df_abundance_mclr <- SPRING::mclr(df_abundance_rel) %>% t() %>% 
  data.frame() %>% 
  rownames_to_column("Contig")
```


```{r TSE}
abundance_matrix <- function(df) {
  rst <- df %>% 
    column_to_rownames("Contig") %>% 
    as.matrix()
  return(rst)
}

feature_anno <- anno_viral %>% 
  column_to_rownames("Contig") %>%
  t() %>% 
  data.frame() %>% 
  dplyr::select(df_counts$Contig) %>% 
  t() %>% 
  DataFrame()

tbl_counts <- abundance_matrix(df_counts)
tbl_trmean <- abundance_matrix(df_trmean)
tbl_covfrac <- abundance_matrix(df_covfrac)

tse <- TreeSummarizedExperiment(assays = SimpleList(counts = tbl_counts,
                                                    trmean = tbl_trmean,
                                                    covfrac = tbl_covfrac),
                                colData = smeta,
                                rowData = feature_anno)
```

```{r}
tse <- transformCounts(tse, method = "relabundance", abund_values = "trmean")
idx_richness <- c("chao1", "ace")
tse <- estimateRichness(tse, abund_values = "counts",
                        index = idx_richness,
                        name = paste0("richness_", idx_richness))

idx_diversity <- c("coverage", "fisher", "shannon")
tse <- estimateDiversity(tse, abund_values = "counts",
                        index = idx_diversity,
                        name = paste0("diversity_", idx_diversity))

idx_evenness <- c("pielou", "camargo", "simpson_evenness", "evar", "bulla")
tse <- estimateEvenness(tse, abund_values = "counts",
                        index = idx_evenness,
                        name = paste0("evenness_", idx_evenness))
# plotColData(tse, "diversity_shannon", "condition")
# plotColData(tse, "richness_chao1", "condition")
# plotColData(tse, "evenness_pielou", "condition")
```

```{r beta diversity}
plot_beta_diversity <- function(tse_obj, name, NMDS=FALSE, scale = F, ...) {
  if (NMDS == TRUE) {
    tse_obj <- runNMDS(tse_obj, FUN = vegan::vegdist, name = name, ...)
    xlab <- "PC 1"
    ylab <- "PC 2"
  } else {
    tse_obj <- runMDS(tse_obj, FUN = vegan::vegdist, name = name, ...)
    e <- attr(reducedDim(tse_obj, name), "eig")
    rel_eig <- 100 * e/sum(e[e>0])
    xlab <- paste("PC 1 (", round(rel_eig[[1]], 2), "%)", sep = "")
    ylab <- paste("PC 2 (", round(rel_eig[[2]], 2), "%)", sep = "")
  }
  p <- plotReducedDim(tse_obj, name, colour_by = "condition") +
    xlab(xlab) +
    ylab(ylab) +
    stat_ellipse(geom = "polygon", alpha=0.1, aes(fill=colour_by), linetype=2) +
    ggtitle(name) +
    theme_bw()
  return(p)
}

p1 <- plot_beta_diversity(tse, name = "PCoA", method = "bray", exprs_values = "relabundance", ntop = nrow(tse))
p2 <- plot_beta_diversity(tse, name = "MDS_euclidean", method = "euclidean", exprs_values = "relabundance", ntop = nrow(tse))
p3 <- plot_beta_diversity(tse, name = "NMDS_BC", method = "bray", exprs_values = "relabundance", ntop = nrow(tse), NMDS = TRUE)
p4 <- plot_beta_diversity(tse, name = "NMDS_euclidean", method = "euclidean", exprs_values = "relabundance", ntop = nrow(tse), NMDS = TRUE)
p1 + p2 + p3 + p4 + plot_layout(guides = "collect")
```

```{r composition, fig.height=6, fig.width=12}
rank_sel <- "Order"
tse_tmp <- tse
tse_tmp <- relAbundanceCounts(tse_tmp, abund_values = "trmean")
tse_rank <- agglomerateByRank(tse_tmp, rank = rank_sel, onRankOnly=F, na.rm=F)
# top_taxa <- getTopTaxa(tse_rank,top = 5, abund_values = "relabundance")
# top_taxa <- top_taxa[str_detect(top_taxa, "NA|___", negate = T)]
taxa_renamed <- lapply(rownames(rowData(tse_rank)),
                   function(x){if (str_detect(x, "NA|__", negate = T)) {x} else {"Other"}})
# rowData(tse_rank)[[rank_sel]] <- rownames(rowData(tse_rank))
rowData(tse_rank)[[rank_sel]] <- as.character(taxa_renamed)
plotAbundance(tse_rank, abund_values="relabundance", rank = rank_sel,
              order_rank_by="abund", add_x_text=T) +
  labs(x = "Samples", y = "Relative abundance")

colnames(tbl_counts)
rownames(rowData(tse_rank))
as.character(taxa_renamed)
tse_rank
```


```{r diversity, fig.height=4, fig.width=5}
library(ggpubr)
plot_diversity <- function(tse_obj, col_diversity, metadata) {
  label.y <- max(colData(tse_obj)[[col_diversity]]) * 1.4
  p <- ggviolin(data.frame(colData(tse_obj)), 
                x = "condition", y = col_diversity, color = "condition", 
                palette = "jco", 
                width = 0.3, 
                legend="none") +
    geom_boxplot(aes(color=condition), width=0.03, alpha=0.5) +
    geom_point() +
    stat_compare_means(comparisons = list(c(unique(metadata$condition))), label.y = label.y) +
    labs(x = "Condition")
  return(p)
}

cols_diversity <- c("richness_chao1", "richness_ace", "diversity_coverage", "diversity_fisher", "diversity_shannon", "evenness_pielou", "evenness_camargo", "evenness_simpson_evenness", "evenness_evar", "evenness_bulla")

for (col in cols_diversity) {
  p <- plot_diversity(tse, col, smeta)
  print(p)
}

```
```{r amg heatmap todo}
df_anno <- fread(fp_dram_anno)
df_amg <- df_anno %>% 
  dplyr::filter(str_detect(amg_flags, "M")) %>% 
  dplyr::filter(auxiliary_score %in% c(1,2,3))
```

```{r sankey}
# Libraries
dft <- rowData(tse_rank) %>% data.frame()
dft[, 70:81] %>% View()

dft <- assay(tse_rank, "relabundance") %>% 
  data.frame() %>% 
  rownames_to_column("source") %>% 
  pivot_longer(cols=H01:UC32, names_to = "target", values_to = "value")

node_all <- data.frame(name=unique(c(dft$source, dft$target)))
nodet <- data.frame(nodename=node_all$name, nodeid=1:length(node_all$name)) %>%
  mutate(nodeid = nodeid - 1) %>% 
  mutate(source = nodename, target=nodename, IDsource=nodeid, IDtarget=nodeid)
dft2 <- dft %>% 
  left_join(nodet[,c('source', 'IDsource')], by = 'source') %>% 
  left_join(nodet[,c('target', 'IDtarget')], by = 'target') %>% 
  data.frame()

sankeyNetwork(Links = dft2, Nodes = node_all,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=F, fontSize=13)
```


## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
df <- anno_viral %>% 
  inner_join(df_abundance_mclr, by = "Contig") %>% 
  column_to_rownames("virsorter2_contig_id") %>% 
  rownames_to_column("Virus")

fwrite(df, file = path_target("virome_rst.tsv"), sep = "\t")
openxlsx::write.xlsx(df, file = path_target("virome_rst.xlsx"))
projthis::proj_dir_info(path_target())
```
